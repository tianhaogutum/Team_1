工作内容详细总结（截至 2025-12-02）

1. 优化 Profile 弹窗显示不全的问题（UI 调整）
   - 对用户资料（Profile）弹窗在不同分辨率和窗口尺寸下的展示情况进行了排查，发现存在内容被遮挡、底部信息无法滚动到的情况，尤其在较小屏幕或浏览器缩放后更明显。
   - 调整了前端组件的布局方式（如弹窗宽高、最大高度、overflow 策略），确保在内容超出可视区域时可以正常滚动查看，而不是被直接截断。
   - 对头像、基础信息、偏好设置等关键区域的间距和对齐方式进行了统一，提升整体观感，让在演示时打开 Profile 能完整、稳定地展示用户信息。

2. 解决需要手动修改数据库读取权限的问题
   - 在本地开发和运行环境中，多次遇到后端无法正常访问 SQLite 数据库文件的问题，需要手工 `chmod` 或修改所属用户组才能继续调试。
   - 针对这一问题，梳理了后端启动流程和数据库文件的生成路径，在脚本或启动逻辑中增加了对数据库文件权限的自动检测与修正（例如设置读写权限、归属用户等）。
   - 通过这一步，避免了每次重启或清理数据后都要人工修改权限，提高了开发与演示的稳定性和可重复性。

3. 白色爱心作为 LLM 是否使用正常的可视化标记（Fallback 识别）
   - 在界面上设计了一种非常轻量的视觉提示：使用“白色爱心”图标来表示当前结果是由 fallback 机制产生，而非真实在线 LLM 响应。
   - 实现了前后端之间的状态传递：当后端检测到 LLM 服务不可用或进入降级通道时，会在返回的数据中写入标记，前端根据该标记决定是否显示白色爱心。
   - 这样在调试和演示过程中，只要看到白色爱心，就能立刻意识到此处走的是 fallback 流程，便于区分“真实 LLM 效果”和“降级备选结果”。

4. 后端 UI / 调试面板，用于最终 Presentation 演示
   - 为后端增加了一个简单但实用的 UI / 调试面板，用来集中展示关键信息，例如服务健康状态、关键接口的调用入口、部分日志摘录等。
   - 在该面板中，可以快速触发一些核心 API（如生成推荐、触发故事生成、查看日志摘要等），方便在演示时通过可视化界面操作，而不需要依赖命令行或 Postman。
   - 此设计让非技术观众在观看最终 Demo 时也能理解系统的“幕后运行情况”，增强项目的可展示性。

5. reset 后删除用户信息的实现
   - 在原有的 reset 功能基础上，增加了清理用户相关数据的逻辑，确保用户点击 reset 后，不仅前端状态重置，后端数据库中的用户记录和衍生数据也会对应清理。
   - 删除的范围包括：用户基础信息、已生成的推荐历史、冒险进度、部分缓存内容等（在保证演示和测试安全的前提下进行设计）。
   - 这样在多轮测试或多位用户轮流演示时，可以一键“回到初始状态”，避免旧数据干扰新的交互。

6. 修复 start trip 报错 “Cannot read properties of undefined (reading 'quest')”
   - 在调试 start trip 流程时，前端控制台出现 `Cannot read properties of undefined (reading 'quest')` 的错误，说明某些情况下返回的数据结构中缺失 `quest` 字段。
   - 通过定位具体触发路径，发现是某些路由或用户状态下，后端没有返回完整的 `quest` 信息，或者前端在未判空的情况下直接访问该字段。
   - 通过两方面修复：一是在后端保证关键字段始终有合理的默认值或结构；二是在前端访问前增加安全校验和默认值处理，最终彻底消除了此类报错。

7. 分析与解决 LLM 503 错误（IPv4 / IPv6 问题 + 诊断脚本）
   - 项目中多次出现 LLM 服务返回 503 的情况，初步排查并非单纯的访问频率问题，而是与底层网络配置（IPv4 / IPv6）、本地代理或服务监听地址有关。
   - 通过分析请求路径与日志，尝试切换和明确使用 IPv4 / IPv6，并检查本地 LLM 服务的监听端口与绑定地址是否匹配。
   - 为了后续快速诊断类似问题，新增了 `scripts/diagnose` 相关脚本：可以一键检测 LLM 服务是否可达、当前网络配置是否正常，并在日志中打印出清晰的排查结果，方便他人复现和解决。

8. 修复点击 start adventure 报错：为所有 routes 生成 breakpoints
   - 在启动冒险（start adventure）时发现报错，排查后确认根源是部分路线（routes）没有对应的 breakpoints 数据，导致前端在渲染地图或模拟时无法找到必要的节点信息。
   - 编写并优化了使用 LLM 为路线批量生成 breakpoints 的脚本／服务：根据每条路线的 GPX 或元数据，自动生成一系列合理的停靠点（breakpoints），包括位置、简短描述等。
   - 为所有现有 routes 补全了 breakpoints 数据，并在后续导入或新增路线时，也串联了同样的自动生成逻辑，确保不会再因为缺少 breakpoints 而导致报错。

9. 推荐分数的可解释性：基于 CBF 的“为什么推荐”说明
   - 为推荐系统引入了可解释层，将原本只有一个数值分数的推荐结果拆解为若干可读的“推荐理由”，主要基于内容过滤（Content-Based Filtering, CBF）的思想。
   - 在后端中，对推荐分数的构成进行了细化，例如与用户历史偏好标签的重合度、与历史路线在难度 / 距离 / 风景类型上的相似度等，并将这些信息一并返回。
   - 前端在展示推荐结果时，可以显示诸如“因为你喜欢湖景和中等强度路线”“与你之前完成的 XX 路线相似度很高”等解释，让推荐变得更加透明、可信。

10. 可推荐项目数量的可调节实现
    - 将原本写死在代码中的“推荐条数”改为可配置参数，在后端服务和前端调用中都支持动态控制数量。
    - 对接口增加了参数（或配置项），可以方便地调整一次返回多少条推荐，用于适配不同终端布局（如移动端只展示少量精华推荐，桌面端可展示更多）。
    - 这一改动也为后续做 AB 测试或根据用户行为自适应调整推荐列表长度提供了基础。

11. 2025-12-02：history 功能修复
    - 针对历史记录（history）模块进行问题排查，发现包括：某些操作未被正确写入历史、历史记录时间顺序不稳定、以及在特定情况下查询不到最近记录等。
    - 优化了后端对历史记录的写入逻辑和查询语句，统一了排序规则（例如按时间倒序）并确保数据完整性。
    - 修复后，用户可以稳定地查看自己过往的冒险、推荐、反馈等操作，为后续基于历史的推荐优化提供可用数据。

12. Souvenir 点击展开查看详情功能
    - 为纪念品（Souvenir）列表增加了“点击展开”的交互行为，用户在点击某个纪念品时，可以查看更大尺寸的图像、详细描述、关联故事等信息。
    - 处理了多张纪念品之间切换时的过渡效果和状态维护，避免出现展开状态错乱或内容残留的问题。
    - 针对移动端和桌面端分别做了适配，确保在小屏幕上展开内容仍然清晰可读、易于关闭和返回列表。

13. Achievement（成就系统）后端实现
    - 设计并实现了成就系统的后端数据结构，包括成就表、用户—成就关联表，以及成就的触发条件字段等。
    - 在关键业务流程中（如完成特定类型的路线、累计达成一定里程数、完成首个冒险等）埋点判定，一旦满足条件便自动解锁对应成就并持久化存储。
    - 对外提供了相应的 API，让前端可以查询用户当前已解锁的成就、成就详情，以及后续可能要展示的成就列表，为 gamification 体验打下基础。

14. 调试信息架构与日志体系优化
    - 重新梳理了后端日志的结构和粒度，将原本零散的打印信息整理为分级日志（info / debug / warning / error 等），并在关键模块中增加上下文信息（如 user_id、route_id、请求耗时等）。
    - 对 LLM 调用、推荐计算、SVG / Souvenir 生成等核心流程增加了更多可观测的信息，在出现错误或结果异常时，可以快速从日志中重现调用链路。
    - 通过这一系列优化，整个系统的可调试性和可运维性大幅提升，同时也为后续编写运维文档和问题排查手册提供了依据。

15. Mock 数据与 LLM 绘制 Souvenir（哈利波特风格）的探索
    - 为了减轻对真实 LLM 服务的依赖，并方便前端与 UI 调试，构造了一套较为丰富的 mock 数据，覆盖不同类型和风格的纪念品。
    - 在生成 Souvenir 的逻辑中，设计了专门面向“哈利波特风格”的提示词与描述模版，让 LLM 生成的结果更符合魔法世界、学院徽章、魔杖、咒语阵等视觉想象。
    - 这些描述和提示词可以进一步被像素画或 SVG 生成模块使用，从而得到更统一美观的视觉风格，为后续真正上线 LLM 绘图能力做准备。

16. 长故事的预生成（LLM Pregeneration）
    - 考虑到长篇故事实时生成的延迟较高、对用户体验影响较大，将长故事的生成逻辑改为在合适时间点进行“预生成”，例如在用户旅程的前期或后台定时任务中提前生成并缓存。
    - 这样，当用户真正点击查看故事时，可以直接读取已经生成好的内容，实现接近“秒开”的体验。
    - 同时，通过在日志中记录预生成的触发条件和结果状态，方便观察 LLM 负载情况以及预生成策略是否合理。

17. Feedback 后端存储与后续算法优化基础
    - 为用户反馈（包括评分、文字评价、是否喜欢某条路线 / 某种风格等）设计并实现了后端数据表和写入接口。
    - 在用户提交反馈时，将这些信息结构化地写入数据库，为后续做统计分析、推荐算法调参和 LLM 提示词优化提供有价值的数据来源。
    - 这一部分工作为形成“用户行为—反馈—算法更新”的闭环打下了基础，后续可以在此之上设计更加智能的自适应推荐。

18. 开场 Open Question 功能
    - 在用户进入体验流程的开始阶段，加入了一个开放式问题（Open Question），鼓励用户用自然语言描述自己的期待、心情或喜欢的冒险风格。
    - 将用户回答的文本内容作为后续推荐与故事生成的重要输入之一，使系统生成的路线、故事和纪念品更贴合用户当前的主观感受。
    - 这一设计增强了系统的个性化程度，让用户感觉到“系统在认真倾听”，而不是仅仅依赖预设的勾选项或量表。

19. Breakpoint 显示问题修复
    - 以前在地图或路线展示中，breakpoints 的位置偶尔会出现错位、不显示或与实际路线不匹配等问题。
    - 经排查发现，问题主要来自坐标格式不统一、部分路线缺少完整的 breakpoints 数据，以及前端渲染逻辑对数据字段的假设不严谨。
    - 通过规范前后端关于经纬度和节点数据的格式、保证数据完整性，并对前端渲染组件进行修正，最终让 breakpoints 能够稳定地出现在正确的位置，提升路线展示的清晰度和可理解性。

20. 设计 “Continue” 之后回到主页面顶部的跳转体验
    - 在用户完成一段流程（例如完成故事阅读、结束一次冒险总结等）之后，设计了 “Continue / 继续” 按钮的行为，使其在返回主页面时自动滚动到主页面顶部。
    - 通过在前端统一封装滚动与路由跳转逻辑，避免出现回到主页面后仍停留在旧的滚动位置的情况，让用户每次回到主视图时都从一个清晰的起点开始浏览。
    - 这一改动在实际体验和演示中提升了整体流畅感，减少用户迷失在页面中部或底部的情况，也方便在 presentation 中有一个可预期、整洁的返回效果。

21. 利用 LLM 自动生成行程总结（Trip Summary）
    - 在用户完成一次行程或冒险后，引入 LLM 自动生成行程总结的功能，根据用户的路线信息、breakpoints、完成情况和偏好，生成一段自然语言的总结文本。
    - 这段总结不仅会回顾本次行程的亮点（例如风景特色、完成的挑战、获得的成就），还可以加入适度的情感化表达与鼓励语，使得每次行程结束都更有“故事收尾”的感觉。
    - 在实现上，与现有的故事生成、Souvenir 描述生成逻辑打通，复用提示词设计与日志记录机制，既保证生成质量，又方便后续调试和迭代提示词。

22. 利用 LLM 为 “Traditional Costume and Shooting Parade Wiesn” 生成哈利波特主题内容（用于演示）
    - 针对 “Traditional Costume and Shooting Parade Wiesn” 这条用于展示的示例路线，专门设计了哈利波特风格的 LLM 提示词，让模型围绕这一场景生成完整的魔法世界剧情故事。
    - 在此基础上，还为该路线生成了配套的魔法主题 quiz（例如关于角色、场景细节、小彩蛋的问答），让观众在 Demo 中既能看故事又能参与互动。
    - 同时对原先的 side quest 设计进行了简化和收束，将精力集中在主线剧情 + quiz 这一条清晰的体验路径上，使得在最终展示时叙事更加集中、节奏更紧凑。


