# 推荐算法优化测试说明

## 测试文件

`test_recommendation_optimization.py` - 测试推荐算法优化功能

## 运行测试

### 前置条件

1. **安装依赖**：
   ```bash
   cd backend
   source venv/bin/activate  # 或 venv\Scripts\activate (Windows)
   pip install -r requirements.txt
   ```

2. **配置数据库**：
   - 确保数据库已初始化（运行过 `alembic upgrade head`）
   - 或者使用测试数据库

### 运行测试

```bash
cd backend
python3 scripts/test_recommendation_optimization.py
```

或者使用虚拟环境：

```bash
cd backend
source venv/bin/activate
python scripts/test_recommendation_optimization.py
```

## 测试内容

### 1. 时间衰减权重计算 ✅
- 测试不同时间间隔的权重计算
- 验证半衰期逻辑（30天）

### 2. 反馈惩罚机制 ✅
- 测试无反馈情况（无惩罚）
- 测试1次反馈（降低到5%）
- 测试2次反馈（降低到1%，最小值限制）
- 测试不同路线（无惩罚）

### 3. 用户偏好向量调整 ✅
- 测试 `too-hard` 反馈（降低最大难度）
- 测试 `too-easy` 反馈（提高最小难度）
- 测试 `too-far` 反馈（减少最大距离）
- 测试 `not-interested` 反馈（移除标签）
- 测试多个反馈的综合影响

### 4. 完整推荐流程 ⚠️
- 需要数据库连接
- 测试无反馈推荐
- 测试添加反馈后的推荐变化
- 测试多次反馈过滤机制

### 5. 分数分解信息 ✅
- 验证分数分解包含所有必要信息

## 测试结果

### 单元测试（无需数据库）
- ✅ 时间衰减权重计算
- ✅ 反馈惩罚机制
- ✅ 用户偏好向量调整
- ✅ 分数分解信息

### 集成测试（需要数据库）
- ⚠️ 完整推荐流程（需要数据库连接）

## 预期输出

```
============================================================
🧪 推荐算法优化测试套件
============================================================

🧪 测试 1: 时间衰减权重计算...
   ✅ 0天前: 1.000
   ✅ 15天前: 0.607
   ✅ 30天前: 0.368
   ✅ 60天前: 0.135
   ✅ 时间衰减权重计算测试通过！

🧪 测试 2: 反馈惩罚机制...
   ✅ 无反馈: 惩罚=1.000 (无惩罚)
   ✅ 1次反馈: 惩罚=0.050 (降低到5%)
   ✅ 2次反馈: 惩罚=0.010 (降低到1%，最小值限制)
   ✅ 不同路线: 惩罚=1.000 (无惩罚)
   ✅ 反馈惩罚机制测试通过！

🧪 测试 3: 用户偏好向量调整...
   ✅ too-hard: 难度范围 [1, 2] -> [1, 1.5]
   ✅ too-easy: 难度范围 [1, 2] -> [1.5, 2]
   ✅ too-far: 最大距离 20.0km -> 18.0km
   ✅ not-interested: 标签调整
   ✅ 多个反馈: 综合调整成功
   ✅ 用户偏好向量调整测试通过！

🎉 所有测试通过！推荐算法优化功能工作正常！
```

## 故障排除

### 问题：ModuleNotFoundError: No module named 'aiosqlite'

**解决方案**：
```bash
pip install aiosqlite
```

### 问题：数据库连接失败

**解决方案**：
1. 确保数据库文件存在：`backend/data/app.db`
2. 运行迁移：`alembic upgrade head`
3. 检查数据库配置：`backend/.env` 或 `backend/env.example`

### 问题：测试数据冲突

**解决方案**：
- 测试使用ID 10001-10004的测试路线
- 如果冲突，可以修改测试中的ID范围

## 测试覆盖

- ✅ 时间衰减计算逻辑
- ✅ 反馈惩罚计算逻辑
- ✅ 用户偏好向量调整逻辑
- ✅ 推荐算法集成
- ✅ 反馈过滤机制

## 下一步

1. 添加性能测试（大量路线和反馈）
2. 添加边界情况测试
3. 添加A/B测试对比
4. 添加监控和日志测试

