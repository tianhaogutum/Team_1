# Migration æ–‡ä»¶æ£€æŸ¥æ¸…å•

## ğŸ“‹ ç”Ÿæˆ Migration åçš„æ£€æŸ¥æ­¥éª¤

### 1. **æ£€æŸ¥æ–‡ä»¶ç»“æ„**

```bash
# æŸ¥çœ‹æ–°ç”Ÿæˆçš„ migration æ–‡ä»¶
ls -la alembic/versions/ | tail -1
```

ç¡®ä¿æ–‡ä»¶å‘½åæ ¼å¼æ­£ç¡®ï¼š
```
{revision_id}_{æè¿°æ€§åç§°}.py
ä¾‹å¦‚ï¼š2a349288b005_add_base_xp_reward_to_routes.py
```

### 2. **æ£€æŸ¥ Revision é“¾**

æ‰“å¼€æ–‡ä»¶ï¼Œæ£€æŸ¥ï¼š

```python
# âœ… å¿…é¡»æ£€æŸ¥
revision: str = '2a349288b005'  # åº”è¯¥æ˜¯æ–°çš„å”¯ä¸€ ID
down_revision: Union[str, None] = 'b02874b51238'  # å¿…é¡»æŒ‡å‘é“¾ä¸­çš„ä¸Šä¸€ä¸ª

# éªŒè¯æ–¹æ³•ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å†å²
# alembic history
```

**éªŒè¯å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹ migration å†å²é“¾
alembic history

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# 2a349288b005 -> b02874b51238 (head)
# b02874b51238 -> b3673a4d0cc8
# ...
```

### 3. **æ£€æŸ¥ upgrade() å‡½æ•°**

#### âœ… åº”è¯¥åŒ…å«çš„æ“ä½œï¼š
- åˆ›å»ºè¡¨ï¼š`op.create_table(...)`
- æ·»åŠ åˆ—ï¼š`op.add_column(...)`
- ä¿®æ”¹åˆ—ï¼š`op.alter_column(...)`
- åˆ›å»ºç´¢å¼•ï¼š`op.create_index(...)`
- æ·»åŠ å¤–é”®ï¼š`op.create_foreign_key(...)`

#### âš ï¸ éœ€è¦äººå·¥æ£€æŸ¥çš„ç‚¹ï¼š

1. **å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®ï¼Ÿ**
   ```python
   # æ£€æŸ¥ï¼šç±»å‹ã€é•¿åº¦ã€nullable
   sa.Column('title', sa.String(length=255), nullable=False)  # âœ…
   sa.Column('title', sa.String(), nullable=True)  # âš ï¸ å¯èƒ½éœ€è¦æŒ‡å®šé•¿åº¦
   ```

2. **é»˜è®¤å€¼æ˜¯å¦åˆç†ï¼Ÿ**
   ```python
   # æ£€æŸ¥ï¼šserver_default æ˜¯å¦æ­£ç¡®
   sa.Column('base_xp_reward', sa.Integer(), server_default=sa.text('0'), nullable=False)  # âœ…
   ```

3. **å¤–é”®çº¦æŸæ˜¯å¦æ­£ç¡®ï¼Ÿ**
   ```python
   # æ£€æŸ¥ï¼šå¼•ç”¨çš„è¡¨å’Œå­—æ®µæ˜¯å¦å­˜åœ¨
   sa.ForeignKeyConstraint(['route_id'], ['routes.id'], ondelete='CASCADE')  # âœ…
   ```

4. **ç´¢å¼•æ˜¯å¦éœ€è¦ï¼Ÿ**
   ```python
   # å¦‚æœç»å¸¸æŸ¥è¯¢çš„å­—æ®µï¼Œå¯èƒ½éœ€è¦æ·»åŠ ç´¢å¼•
   # op.create_index('idx_route_id', 'breakpoints', ['route_id'])
   ```

### 4. **æ£€æŸ¥ downgrade() å‡½æ•°**

#### âœ… å¿…é¡»å®Œå…¨å¯¹ç§°ï¼š

```python
# upgrade åšäº†ä»€ä¹ˆï¼Œdowngrade å¿…é¡»å®Œå…¨æ’¤é”€

# ç¤ºä¾‹ 1ï¼šæ·»åŠ åˆ—
def upgrade() -> None:
    op.add_column('routes', sa.Column('new_field', sa.String()))

def downgrade() -> None:
    op.drop_column('routes', 'new_field')  # âœ… å®Œå…¨å¯¹ç§°

# ç¤ºä¾‹ 2ï¼šåˆ›å»ºè¡¨
def upgrade() -> None:
    op.create_table('new_table', ...)

def downgrade() -> None:
    op.drop_table('new_table')  # âœ… å®Œå…¨å¯¹ç§°

# ç¤ºä¾‹ 3ï¼šå¤šä¸ªæ“ä½œï¼ˆæ³¨æ„é¡ºåºï¼ï¼‰
def upgrade() -> None:
    op.add_column('routes', sa.Column('field1', sa.String()))
    op.add_column('routes', sa.Column('field2', sa.String()))

def downgrade() -> None:
    op.drop_column('routes', 'field2')  # âš ï¸ æ³¨æ„ï¼šé¡ºåºç›¸åï¼
    op.drop_column('routes', 'field1')
```

### 5. **æ£€æŸ¥è‡ªåŠ¨ç”Ÿæˆçš„æ ‡è®°**

å¦‚æœçœ‹åˆ°è¿™äº›æ³¨é‡Šï¼Œè¯´æ˜æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œéœ€è¦ä»”ç»†æ£€æŸ¥ï¼š

```python
# ### commands auto generated by Alembic - please adjust! ###
op.add_column('routes', sa.Column('elevation', sa.Integer(), nullable=True))
# ### end Alembic commands ###
```

**æ£€æŸ¥æ¸…å•ï¼š**
- [ ] å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] nullable è®¾ç½®æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦é»˜è®¤å€¼ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ç´¢å¼•ï¼Ÿ
- [ ] å­—æ®µåæ˜¯å¦æ­£ç¡®ï¼Ÿ

### 6. **æµ‹è¯• Migration**

åœ¨åº”ç”¨ migration ä¹‹å‰ï¼Œå…ˆæµ‹è¯•ï¼š

**ğŸ“ æ‰§è¡Œä½ç½®ï¼š** åœ¨ `backend/` ç›®å½•ä¸‹æ‰§è¡Œæ‰€æœ‰ Alembic å‘½ä»¤

```bash
# è¿›å…¥ backend ç›®å½•
cd backend

# 1. æŸ¥çœ‹ä¼šæ‰§è¡Œä»€ä¹ˆ SQLï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
alembic upgrade head --sql

# 2. æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# 3. æŸ¥çœ‹éœ€è¦åº”ç”¨çš„ migrations
alembic heads

# 4. åœ¨æµ‹è¯•ç¯å¢ƒå…ˆè¿è¡Œ
alembic upgrade head

# 5. æµ‹è¯•å›æ»šï¼ˆé‡è¦ï¼ï¼‰
alembic downgrade -1

# 6. å†å‡çº§å›æ¥
alembic upgrade head
```

### 7. **å¸¸è§é—®é¢˜æ£€æŸ¥**

#### âŒ é—®é¢˜ 1ï¼šåŒ…å«ä¸šåŠ¡é€»è¾‘
```python
# âŒ ä¸å¥½
def upgrade() -> None:
    op.add_column('users', sa.Column('email', sa.String()))
    op.execute("UPDATE users SET email = 'default@example.com'")  # ä¸åº”è¯¥åœ¨è¿™é‡Œ

# âœ… å¥½ï¼šåªåšç»“æ„å˜æ›´
def upgrade() -> None:
    op.add_column('users', sa.Column('email', sa.String()))
```

#### âŒ é—®é¢˜ 2ï¼šdowngrade ä¸å®Œæ•´
```python
# âŒ ä¸å¥½ï¼šdowngrade ç¼ºå°‘æ“ä½œ
def upgrade() -> None:
    op.add_column('routes', sa.Column('field1', sa.String()))
    op.add_column('routes', sa.Column('field2', sa.String()))

def downgrade() -> None:
    op.drop_column('routes', 'field1')  # ç¼ºå°‘ field2ï¼

# âœ… å¥½ï¼šå®Œå…¨å¯¹ç§°
def downgrade() -> None:
    op.drop_column('routes', 'field2')
    op.drop_column('routes', 'field1')
```

#### âŒ é—®é¢˜ 3ï¼šé¡ºåºé”™è¯¯
```python
# âš ï¸ æ³¨æ„ï¼šdowngrade çš„é¡ºåºåº”è¯¥ä¸ upgrade ç›¸å
def upgrade() -> None:
    op.create_table('table1', ...)
    op.create_table('table2', ...)  # table2 å¯èƒ½ä¾èµ– table1

def downgrade() -> None:
    op.drop_table('table2')  # å…ˆåˆ é™¤ä¾èµ–çš„è¡¨
    op.drop_table('table1')  # å†åˆ é™¤è¢«ä¾èµ–çš„è¡¨
```

#### âŒ é—®é¢˜ 4ï¼šå­—æ®µç±»å‹ä¸åŒ¹é…
```python
# âŒ ä¸å¥½ï¼šç±»å‹ä¸ä¸€è‡´
# æ¨¡å‹ä¸­æ˜¯ String(100)ï¼Œä½† migration ä¸­æ˜¯ String()
sa.Column('title', sa.String(), nullable=False)  # ç¼ºå°‘é•¿åº¦é™åˆ¶

# âœ… å¥½ï¼šä¸æ¨¡å‹ä¸€è‡´
sa.Column('title', sa.String(length=100), nullable=False)
```

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

ç”Ÿæˆ migration åï¼Œå¿«é€Ÿæ£€æŸ¥ï¼š

- [ ] **æ–‡ä»¶å‘½å**ï¼šæ ¼å¼æ­£ç¡®ï¼Œæè¿°æ¸…æ™°
- [ ] **revision é“¾**ï¼š`down_revision` æŒ‡å‘æ­£ç¡®çš„ä¸Šä¸€ä¸ª migration
- [ ] **upgrade()**ï¼šåŒ…å«æ‰€æœ‰éœ€è¦çš„æ“ä½œï¼Œç±»å‹ã€çº¦æŸæ­£ç¡®
- [ ] **downgrade()**ï¼šå®Œå…¨å¯¹ç§°ï¼Œèƒ½å®Œå…¨æ’¤é”€ upgrade çš„æ“ä½œ
- [ ] **æ— ä¸šåŠ¡é€»è¾‘**ï¼šåªåŒ…å«ç»“æ„å˜æ›´ï¼Œä¸åŒ…å«æ•°æ®æ“ä½œ
- [ ] **æµ‹è¯•é€šè¿‡**ï¼š`alembic upgrade head` å’Œ `alembic downgrade -1` éƒ½èƒ½æˆåŠŸ

## ğŸ“ ç¤ºä¾‹ï¼šå®Œæ•´çš„æ£€æŸ¥æµç¨‹

**ğŸ“ é‡è¦ï¼šæ‰€æœ‰ Alembic å‘½ä»¤éƒ½åœ¨ `backend/` ç›®å½•ä¸‹æ‰§è¡Œ**

```bash
# 0. è¿›å…¥ backend ç›®å½•ï¼ˆå¦‚æœä¸åœ¨çš„è¯ï¼‰
cd /Users/tianhaogu/Downloads/Team_1/backend
# æˆ–è€…ä»é¡¹ç›®æ ¹ç›®å½•ï¼š
cd backend

# 1. ç”Ÿæˆ migration
alembic revision --autogenerate -m "add_new_field_to_routes"

# 2. æ‰“å¼€ç”Ÿæˆçš„æ–‡ä»¶æ£€æŸ¥
# æ–‡ä»¶ä½ç½®ï¼šbackend/alembic/versions/xxxxx_add_new_field_to_routes.py

# 3. æ£€æŸ¥ revision é“¾
alembic history | head -5

# 4. æŸ¥çœ‹ä¼šæ‰§è¡Œä»€ä¹ˆ SQLï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
alembic upgrade head --sql

# 5. åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
alembic upgrade head

# 6. æµ‹è¯•å›æ»š
alembic downgrade -1

# 7. å†å‡çº§å›æ¥
alembic upgrade head

# 8. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæäº¤åˆ° Git
git add alembic/versions/xxxxx_add_new_field_to_routes.py
git commit -m "Add migration: add_new_field_to_routes"
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦åœ¨ backend ç›®å½•æ‰§è¡Œï¼Ÿ**
- `alembic.ini` é…ç½®æ–‡ä»¶åœ¨ `backend/` ç›®å½•
- Alembic éœ€è¦è¯»å– `alembic.ini` æ¥æ‰¾åˆ° migration è„šæœ¬çš„ä½ç½®
- `prepend_sys_path = .` é…ç½®è¦æ±‚ä» backend ç›®å½•æ‰§è¡Œï¼Œæ‰èƒ½æ­£ç¡®å¯¼å…¥ Python æ¨¡å—

