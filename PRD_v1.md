# **产品需求文档 (PRD): TrailSaga – Hogwarts Expedition Series**

版本: 1.4 (XP 可解锁特殊路线 & 路线模拟地图)  
日期: 2025 年 11 月 15 日  
产品负责人: (Your Name)  
状态: 需求定义 (Prototype 阶段)

## **1. 引言**

### **1.1. 产品愿景**

TrailSaga – Hogwarts Expedition Series 旨在打造一个“游戏化的户外路线推荐系统”原型 (Gamified Tourism Recommender)。我们不仅仅是推荐路线，更是将每一次户外探索（如 City Walk, Hiking, Trail Running）转变为一场个性化、循序渐进的冒险故事。

### **1.2. 项目目标 (Prototype)**

- **核心体验**: 验证“游戏化叙事”的核心循环对用户的吸引力。
- **技术可行性**:
  1. 实现一个基于内容的推荐（CBF）与自适应重排（Adaptive Re-ranking）的基础模型。
  2. 集成 GenAI (LLM) 按需生成个性化故事、迷你任务 (Mini-Quests) 和总结。
  3. 构建一个“模拟徒步模式”以在不依赖真实 GPS 的情况下完整演示产品闭环。
- **项目交付**: 一个可交互的 Web App 原型。
- **工作人员**: 三人。

### **1.3. 目标用户**

- **主要用户**: 喜欢户外活动（徒步、City Walk、越野跑等）并寻求新奇体验的用户，特别是对游戏化和成就体系（如 XP、徽章）有高接受度的年轻群体。
- **次要用户**: 刚接触户外运动，需要引导和激励来培养习惯的新手。

### **1.4. 成功指标 (Prototype)**

1. **演示完整性**: 能够完整演示从“冷启动问卷” → “个性化推荐” → “模拟徒步” → “触发任务” → “XP 结算” → “AI 总结” 的核心闭环。
2. **自适应有效性**: 演示用户反馈（如“太难”）后，下一次推荐结果有明显可见的调整。
3. **GenAI 集成**: GenAI 能够根据路线和用户偏好，稳定生成结构化的叙事文本和 Mini-Quests。

## **2. 核心功能模块 (Features)**

基于项目构想，产品原型将围绕以下四大核心模块构建：

### **模块一：冷启动与用户画像**

用户通过一个轻量级问卷（3–5 个问题）完成冷启动，系统生成初始画像。**大部分路线均可自由选择**，不设硬性限制。

### **模块二：推荐系统 (Recommender)**

采用基于内容的推荐 (CBF) + 自适应重排。

1. **CBF**: 匹配用户向量（来自问卷和行为）与路线向量（难度、距离、地形等）。
2. **自适应重排**: 根据用户的即时反馈（如“太远”、“太难”）动态调整推荐排序的权重（如 Distance_Penalty, Difficulty_Bias）。

### **模块三：游戏化与成长体系 (Gamification & Progression)**

这是 TrailSaga – Hogwarts Expedition Series 的核心特色模块。

- **XP & 徽章 (XP & Badges)**

  - 完成路线、完成 Mini-Quests、完成首次活动类型等行为可获得 XP 和徽章；
  - XP & 等级主要用于：
    - 成就展示（在个人资料 & 纪念画廊中显示）；
    - 解锁部分随机标记为“特殊路线 / Epic Route”的内容。

- **AI 叙事 (Narratives)**

  - 为每条路线生成对应的挑战故事、背景设定或主题（例如“晨雾中的城市探险”）；
  - 文本简洁（3–5 段以内），便于在移动端或小屏幕展示。

- **AI 迷你任务 (Mini-Quests)**

  - 按路线的 breakpoints 生成与地点相关的简单任务，例如“在城市广场寻找某个雕像并合照（Demo 中可模拟完成）”；
  - 任务难度应轻量，以“引导用户多看一眼周围”为目标。

- **AI 总结 (Post-run Summary)**

  - 完成路线后，LLM 根据路线特征、完成时间、完成情况等生成一段 personalized summary + 下一步挑战建议。

- **路线模拟地图与 Breakpoint 面板**

  - 前端为每条路线提供一个**简化版“路线地图”面板**：
    - 用折线/曲线表现路线的大致形态（不追求真实地理位置）；
    - 在线上标记若干 breakpoints（关键路段、POI 或故事节点）；
    - 显示一个代表用户的“小人”/图标，表示当前所在 breakpoint；
  - 在“模拟徒步模式”中：
    - 每点击一次 **“Next Breakpoint”** 按钮，小人沿折线移动到下一个 breakpoint 并高亮；
    - 若该 breakpoint 绑定故事或 Mini-Quest，则自动触发对应事件（任务卡 / 文本弹窗）。

- **Digital Souvenir & Gallery（数字纪念品与纪念画廊）**
  - 每次完成路线后生成一张数字纪念卡（Digital Souvenir），包含：路线名称、地点、完成日期、获得徽章等；
  - 首页提供一个 **“Souvenir Spotlight”** 小组件，展示最近一张或数张纪念卡，并提供“查看全部纪念品”入口；
  - 用户可以进入独立的 **“My Souvenirs”** 页面，以时间轴/网格形式浏览全部冒险历史；

### **模块四：用户交互与自适应学习**

用户可在路线卡片上进行（ 👎 / ⏭ ）操作。对于 👎 反馈，系统会引导用户选择具体原因（太远、太难、不感兴趣等）。所有反馈将实时用于更新用户画像和推荐模型的偏置参数。

## **3. 详细用户故事 (User Stories)**

以下是构建原型所需实现的核心用户故事 (US)。

### US-01: 未登录的冷启动推荐

- **用户视角**  
  作为一名第一次访问网站的用户，我希望在首页立即看到若干热门基础路线，这样即使不登录也能快速浏览内容。

- **系统视角**  
  系统在未登录状态下，使用固定规则（如“德国 + 高评分 + 多人收藏”）展示一个“热门推荐”模块，不依赖用户画像。

---

### US-02: 登录后进入个性化首页

- **用户视角**  
  作为一名已登录用户，我希望首页展示根据我偏好排序过的推荐路线，这样我打开应用就能直接看到对我最有意义的选择。

- **系统视角**  
  系统在用户登录后，从 CBF + 重排模块获取个性化推荐列表，并将其作为首页主列表（替代默认热门列表）。

---

### US-03: 首次登录时填写冷启动问卷

- **用户视角**  
  作为一名新注册的用户，我希望只需回答 3–5 个关于体能、路线风格、故事偏好的问题，就可以获得更贴合我的首批路线推荐。

- **系统视角**  
  系统检测到用户为首次登录：
  - 弹出轻量问卷（非强制，但强烈建议填写）；
  - 将问卷答案映射为初始用户向量（体能/偏好/故事风格标签）；
  - 将该向量写入用户画像表，用于 CBF 初始化。

---

### US-04: 问卷完成后的探险家身份总结 (GenAI Welcome)

- **用户视角**  
  作为一名新用户，我希望在完成问卷后看到一段有趣的“探险家身份总结”（如“City Explorer”、“Weekend Mountain Adventurer”），让我对接下来的体验更有代入感。

- **系统视角**  
  系统在问卷提交后：
  - 将用户体能、偏好等特征封装成 prompt；
  - 调用 LLM 生成一段 2–3 段落的个性化描述；
  - 在欢迎界面展示，并可在个人主页复用。

---

### US-05: 在首页选择活动类型

- **用户视角**  
  作为一名用户，我希望在首页直接选择当前想进行的活动类型（比如 Hiking、City Walk），这样可以快速缩小推荐范围。

- **系统视角**  
  首页提供活动类型筛选条：
  - 用户选择某一类型后，对推荐结果进行过滤+重排；
  - 保留“全部类型”作为默认选项。

---

### US-06: 为路线生成定制故事 (LLM Narrative)

- **用户视角**  
  作为一名喜欢故事感的用户，我希望可以为我正在查看的一条具体路线生成一段个性化的挑战故事或背景叙事，让我在出发前有“踏上任务”的感觉。

- **系统视角**  
  在路线详情页：
  - 收集路线基本信息（地点、长度、地形等）和用户偏好标签；
  - 将这些信息传入 LLM 生成故事文本（含标题 + 正文）；
  - 将结果以“故事卷轴”或卡片样式展示在 UI 中。

---

### US-07: 查看路线结构和 Breakpoints（故事节点）

- **用户视角**  
  作为一名用户，我希望在开始路线前看到该路线被拆分成的几个关键节点（breakpoints），以及一个直观表现路线大致形态的简化地图，这样我能提前理解整条路线被划分成几个“章节”。

- **系统视角**  
  在路线详情页：
  - 生成或读取该路线的 breakpoints 列表（B1, B2, …），附带基本信息（里程位置、是否有任务/故事）；
  - 渲染一个简化版路线模拟地图面板：
    - 用折线/曲线大致表示路线轨迹；
    - 在线上标注出 breakpoints；
    - 预留一个“当前角色位置”的小人图标，用于后续模拟徒步模式。

---

### US-08: 在路线卡片上给出即时负面反馈

- **用户视角**  
  作为一名用户，我希望在推荐列表中看到不合适的路线时，可以直接点 👎 并快速选择原因（例如“太远”“太难”），让系统更快学习我的偏好。

- **系统视角**
  - 用户点击 👎 后，弹出原因选择弹窗（太远 / 太难 / 不感兴趣 / 不在当前区域 等）；
  - 将反馈写入行为日志表（含路线 ID、时间、原因）；
  - 根据原因更新用户偏置参数（如降低长距离权重）。

---

### US-09: 在模拟徒步模式下通过按钮前进 (Next Breakpoint)

- **用户视角**  
  作为一名 Demo 用户，我希望在“模拟徒步模式”中，通过点击“Next Breakpoint”按钮来替代真实的 GPS 移动，从而体验路线章节推进和故事演进。

- **系统视角**  
  在模拟徒步模式中提供 **“≫ Next Breakpoint”** 按钮：
  - 每次点击时，后端将“当前进度”从 breakpoint i 更新为 breakpoint i+1；
  - 前端路线模拟地图面板上的小人，从上一个 breakpoint 平滑移动到下一个 breakpoint，并高亮当前节点；
  - 若该 breakpoint 绑定故事节点或 Mini-Quest，则触发相应事件（弹出故事卷轴或任务卡）。

---

### US-10: 在 breakpoint 处接受 Mini-Quest 任务

- **用户视角**  
  作为一名用户，我希望在到达某个 breakpoint 时收到一个清晰的 Mini-Quest 任务卡，让每段路都有小目标。

- **系统视角**
  - 当用户抵达带任务的 breakpoint 时：
    - 从预生成或实时生成的任务列表中取出对应任务；
    - 在前端渲染任务卡（overlay）的形式；
    - 任务卡与当前 breakpoint 在 UI 上有视觉关联（如出现在地图右侧或对应节点附近）；
  - 任务内容包含：标题、简短描述、完成方式（拍照打卡/观察周围/简单问答等）、XP 奖励。

---

### US-11: 完成 Mini-Quest 并获得即时 XP 奖励

- **用户视角**  
  作为一名用户，我希望在完成 Mini-Quest 后立刻看到 XP 增长，以及视觉上的“任务完成”反馈，这让我有成就感并更愿意继续走下去。

- **系统视角**
  - 用户在 Demo 中点击“Complete Quest”按钮模拟完成任务；
  - 后端增加对应 XP，并将 XP 变动写入日志；
  - 前端触发“+XX XP” 的浮动动画、更新 XP 条和等级显示。

---

### US-12: 查看 XP 构成和升级进度 (Multi-factor XP Breakdown)

- **用户视角**  
  作为一名用户，我希望在完成整条路线后，看到一份清晰的 XP 构成明细（按距离、难度、任务、天气等维度拆分），并且能看到自己距离下一级还差多少 XP。

- **系统视角**
  - 在路线完成时展示 XP 结算界面；
  - 按不同来源展示 XP（基础里程 XP、难度加成、任务 XP、特殊加成）；
  - 更新用户总 XP 和等级，并显示“距离下一级还差 XX XP”。

---

### US-13: 完成路线后的 GenAI 总结与下一步建议

- **用户视角**  
  作为一名用户，我希望在每次完成路线后收到一段个性化的总结，以及下一步挑战建议（例如“下次尝试稍微再长一点的城市路线”）。

- **系统视角**
  - 收集当前路线特征、用户当前等级、是否完成全部 Mini-Quests 等信息；
  - 将这些信息作为 prompt 调用 LLM；
  - 生成 3–5 句总结与建议，在结算界面展示，并可保存到纪念卡或历史记录中。

---

### US-14: 使用 XP 解锁特殊路线

- **用户视角**  
  作为一名用户，我希望在推荐列表中看到一些被锁定的“特殊路线”或“史诗路线”，并能用我积累的 XP 去解锁它们，这让我更有目标感。

- **系统视角**
  - 后端为部分路线配置 `xp_required` 字段；
  - 若用户当前 XP < xp_required，则在卡片上显示“锁定”状态及所需 XP；
  - XP 达标后出现“解锁”按钮，并允许用户用 XP 解锁访问权限（MVP 可只模拟解锁，不实际扣减 XP）。

---

### US-15: 获取 Digital Souvenir（数字纪念品）并在首页快速回顾

- **用户视角**  
  作为一名希望记录旅程的用户，我希望在完成路线后能获得一张数字纪念卡，并且在首页就能看到我最近的一次或几次冒险，这样我既可以在“我的纪念画廊”中系统回顾所有成就，也能在每次打开应用时被自己的进展所激励。

- **系统视角**
  - 在路线完成后生成一条 Digital Souvenir 记录：
    - 包含路线名称、地点、完成日期、获得 XP / 徽章等；
  - 将该纪念品写入用户的“纪念画廊”数据表；
  - 更新首页的 **“Souvenir Spotlight”** 小组件，使其展示最近的 1–N 张纪念卡缩略图；
  - 在用户下次访问首页时，从缓存或数据库读取最近纪念卡并渲染，同时提供“查看全部纪念品”的入口。

---

### US-16: 从首页进入“我的纪念画廊”（Digital Souvenir Hub）

- **用户视角**  
  作为一名经常回到应用的用户，我希望在首页就能一眼看到我最近的冒险纪念卡，并通过一个清晰的入口进入“我的纪念画廊”，这样我不用在菜单里到处寻找，就能方便地回顾所有完成过的路线。

- **系统视角**
  - 首页布局中预留 **“Souvenir Spotlight / 我的纪念碎片”** 区块：
    - 展示最近 1–3 条路线的纪念卡缩略版；
    - 每张卡包含路线名称、完成日期、小的 XP/徽章标识；
  - 在该区块中提供明显 CTA 按钮，例如 “View all Souvenirs / 打开纪念画廊”；
  - 用户点击任一纪念卡或 CTA 按钮时，跳转到 **“My Souvenirs / 纪念画廊”** 页面：
    - 以时间倒序列出所有纪念品；
    - MVP 阶段可选支持按活动类型/地点进行简单筛选；
  - 系统记录用户在纪念画廊中的浏览和点击数据，用作后续推荐系统的偏好信号（如“最近常看某地区纪念卡”）。

## **4. MVP 演示核心：模拟徒步模式**

- **目标**: 在不依赖真实 GPS 硬件和数据的情况下，完整演示 US-09 至 US-13 的游戏化闭环，并突出前端的“路线模拟地图 + breakpoints + 小人移动”。

### 4.1 核心 UI 元素

- **路线模拟地图面板**

  - 简化的折线/曲线路线形态；
  - 按顺序标记 breakpoints（B1, B2, …）；
  - 小人图标表示当前所在 breakpoint；

- **进度 & 状态区域**

  - 当前 breakpoint 进度（如 “2 / 5”）；
  - 路线完成进度条；
  - 当前总 XP、本次路线已获得 XP；

- **主操作按钮**

  - “≫ Next Breakpoint”：每点击一次 → 小人移动到下一个 breakpoint → 触发可能的故事/任务。

- **Souvenir Spotlight（首页组件）**
  - 在完成路线后，首页顶部或中部出现小模块展示最近的 Digital Souvenir；
  - 包含“查看全部纪念品”按钮。

---

### 4.2 Demo Flow（演示流程）

1. 用户首次进入网站 → 未登录：看到热门路线列表。
2. 用户注册并登录 → 触发冷启动问卷（US-03） → GenAI 探险家身份总结（US-04）。
3. 用户选择某条推荐路线 → 进入路线详情页，查看：
   - 路线模拟地图与 breakpoints（US-07）；
   - 该路线的故事简介（US-06）。
4. 用户点击“Start Simulation” → 进入模拟徒步模式：
   - 可见路线模拟地图、小人、进度条和 “Next Breakpoint” 按钮。
5. 用户多次点击 “Next Breakpoint”：
   - 小人依次沿 breakpoints 移动（US-09）；
   - 在特定节点弹出故事卷轴或 Mini-Quest 任务卡（US-10）；
   - 完成任务获得 XP 动画反馈（US-11）。
6. 当所有 breakpoints 完成，用户抵达终点：
   - 展示 XP 构成 & 升级情况（US-12）；
   - GenAI 生成本次冒险总结 & 下一步建议（US-13）；
   - 生成一张 Digital Souvenir 纪念卡（US-15）。
7. 用户返回首页：
   - 首页 Souvenir Spotlight 展示刚刚获得的纪念卡缩略图，并提供进入纪念画廊的入口（US-15、US-16）。
8. 用户点击“View all Souvenirs” → 进入纪念画廊页面，浏览历史路线纪念，并可点击某张纪念卡继续查看类似路线。

### **4.3 技术证明**

该链路将证明：

- 前端可以用**简化地图 + breakpoints + 小人移动**的交互方式，直观展示路线进度；
- GenAI 能够生成结构化任务与叙事，并与特定 breakpoints 绑定；
- XP 与用户偏好等状态可以在后端实时更新并在前端正确反馈。

## **5. 非功能性需求**

- **技术栈**:

  - 后端: FastAPI (Python)
  - 前端: React (TypeScript)
  - ORM: SQLAlchemy
  - 数据库: local sqlite

- **视觉风格**: 复古像素艺术风格 (Retro Pixel Art Style)。

- **数据源**:

  - Outdooractive API（用于获取基础路线、POI、难度、距离等信息）。
  - **数据使用与存储约束**：
    - 所有从 Outdooractive API 获取的原始数据（如路线详情、POI 信息等）**必须存储在每个开发者的本地设备上**（例如本机 SQLite 文件、JSON 文件），用于本地开发与演示；
    - 该数据**不得上传**至任何公共云服务（如 Supabase、Cloud Postgres、S3 等）、第三方托管数据库或 Git 仓库；

- **AI 依赖**: 本地部署的 TinyLlama，用于生成故事、Mini-Quests 和总结。

## **6. 假设与未来范围**

- **假设**: 能获取 Outdooractive 数据；TinyLlama 在本地部署后可以稳定响应；Gamification 为当前阶段优先展示点。
- **未来范围**:
  - 真实 GPS 定位与轨迹记录；
  - 混合推荐（协同过滤 + 嵌入模型）；
  - 社交功能（好友、队伍、排行榜）；
